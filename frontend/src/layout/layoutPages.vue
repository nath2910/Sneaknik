<template>
  <div class="h-screen flex flex-col font-poppins text-slate-100 bg-slate-950">
    <!-- Header -->
    <template v-if="!isAuthRoute">
      <!-- Header for stats: simple bar -->
      <header class="fixed top-4 left-0 right-0 z-50 pointer-events-none">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between pointer-events-none">
          <!-- Left spacer / burger -->
          <div class="flex items-center pointer-events-auto">
            <button
              type="button"
              class="md:hidden text-gray-300 hover:text-white p-2 rounded-xl hover:bg-white/5 transition"
              @click.stop="toggleMobileMenu"
              aria-label="Ouvrir le menu"
              :aria-expanded="mobileMenuOpen"
            >
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path
                  v-if="!mobileMenuOpen"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
                <path
                  v-else
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Center nav -->
          <nav
            v-motion
            :initial="false"
            :variants="navVariants"
            :animate="navBubble ? 'compact' : 'normal'"
            :transition="navSpring"
            class="hidden md:flex items-center justify-center pointer-events-auto mx-auto"
            :class="navBubble
              ? 'gap-3 px-4 py-2 rounded-full bg-slate-900/70 border border-white/10 shadow-[0_12px_30px_rgba(0,0,0,0.35)] backdrop-blur-md'
              : 'gap-8 px-8 py-3 rounded-full bg-transparent text-white'"
          >
            <RouterLink to="/" :class="compactLink('/')">Accueil</RouterLink>
            <RouterLink to="/stats" :class="compactLink('/stats')">Stats</RouterLink>
            <RouterLink to="/gestion" :class="compactLink('/gestion')">Gestion</RouterLink>
          </nav>

          <!-- Right user menu -->
          <div class="flex items-center justify-end pointer-events-auto">
            <div class="relative" @click.stop>
              <button
                type="button"
                @click.stop="toggleUserMenu"
                class="h-9 w-9 rounded-full flex items-center justify-center border transition focus:outline-none bg-slate-900/70 border-white/10 hover:border-emerald-300/50 backdrop-blur-md"
                aria-label="Menu utilisateur"
                :aria-expanded="menuOpen"
              >
                <span class="text-sm font-semibold text-white">{{ initials }}</span>
              </button>

              <div
                v-if="menuOpen"
                class="absolute right-0 mt-2 w-56 rounded-lg bg-white text-slate-900 shadow-lg border border-purple-900 z-50"
              >
                <div class="px-4 py-3 border-b border-slate-100">
                  <p class="text-sm text-purple-900">
                    {{ currentUser ? 'Connect√©' : 'Non connect√©' }}
                  </p>
                  <p v-if="currentUser" class="text-sm font-medium text-slate-900 truncate">
                    Bienvenue {{ currentUser.firstName }}
                  </p>
                </div>

                <div
                  class="py-2 [&_button]:w-full [&_button]:text-left [&_button]:px-4 [&_button]:py-2 [&_button]:text-sm [&_button]:transition-colors [&_button:hover]:bg-slate-200 [&_button:active]:bg-slate-200"
                >
                  <button v-if="!currentUser" type="button" @click="goToAuth('login')">
                    Se connecter
                  </button>

                  <button v-if="!currentUser" type="button" @click="goToAuth('signup')">
                    Cr√©er un compte
                  </button>

                  <button v-if="currentUser" type="button" @click="goToAccount">
                    G√©rer mon compte
                  </button>

                  <button
                    v-if="currentUser"
                    type="button"
                    @click="logout"
                    class="text-red-600 [&:hover]:bg-red-50 [&:active]:bg-red-100"
                  >
                    Se d√©connecter
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile menu -->
        <div v-if="mobileMenuOpen" class="md:hidden px-4 pb-3 pointer-events-auto" @click.stop>
          <div class="mt-2 rounded-2xl bg-gray-900/70 border border-white/10 backdrop-blur p-2">
            <RouterLink
              to="/"
              class="block px-3 py-2 rounded-md text-base font-medium"
              :class="isActiveMobile('/')"
              @click="closeMenus"
            >
              Accueil
            </RouterLink>

            <RouterLink
              to="/stats"
              class="block px-3 py-2 rounded-md text-base font-medium"
              :class="isActiveMobile('/stats')"
              @click="closeMenus"
            >
              Stats
            </RouterLink>

            <RouterLink
              to="/gestion"
              class="block px-3 py-2 rounded-md text-base font-medium"
              :class="isActiveMobile('/gestion')"
              @click="closeMenus"
            >
              Gestion
            </RouterLink>
          </div>
        </div>
      </header>
    </template>

    <!-- Body -->
    <main class="bg-slate-950/30 flex-1 min-h-0">
      <div v-if="route.meta.fullBleed" class="relative h-full w-full overflow-hidden">
        <slot />
      </div>

      <div v-else ref="pageScroll" class="h-full overflow-auto">
        <div class="relative min-h-full">
          <div class="pointer-events-none absolute inset-0 -z-10 overflow-hidden" aria-hidden="true">
            <div class="absolute -top-40 right-[-10%] h-96 w-96 rounded-full bg-emerald-400/4 blur-3xl"></div>
            <div class="absolute bottom-[-30%] left-[-10%] h-[30rem] w-[30rem] rounded-full bg-amber-400/4 blur-3xl"></div>
            <div class="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(15,23,42,0.25),_transparent_60%)]"></div>
          </div>
          <div class="min-h-full max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-12 pb-16">
            <slot />
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer
      v-if="!route.meta.fullBleed && !isAuthRoute"
      class="fixed left-0 right-0 bottom-4 flex justify-center transition-opacity duration-500 ease-out pointer-events-none"
      :class="footerVisible ? 'opacity-100' : 'opacity-0'"
    >
      <div class="pointer-events-auto inline-flex items-center gap-6 px-7 py-3 rounded-full border border-white/10 bg-slate-900/85 backdrop-blur-md text-sm shadow-[0_14px_32px_rgba(0,0,0,0.38)]">
        <span class="font-jetbrains-mono">&copy; {{ new Date().getFullYear() }} ‚Äî Stash</span>
        <a href="#" class="hover:underline">√Ä propos</a>
        <a href="mailto:nathantalvasson@gmail.com" class="hover:underline">contact</a>
      </div>
    </footer>
  </div>
</template>

<script setup>
import { computed, ref, watch, onMounted, onBeforeUnmount, nextTick } from 'vue'
import { useRoute, useRouter, RouterLink } from 'vue-router'
import { useAuthStore } from '@/store/authStore'

const route = useRoute()
const router = useRouter()

const isStats = computed(() => route.path === '/stats')
const isAuthRoute = computed(() =>
  [
    'auth',
    'forgot-password',
    'reset-password',
    'authCallback',
    'verify-email',
    'account',
  ].includes(route.name),
)

const navSpring = {
  type: 'spring',
  stiffness: 260,
  damping: 32,
  mass: 1.05,
}

const navVariants = {
  normal: {
    opacity: 1,
    y: 0,
    scale: 1,
    filter: 'blur(0px)',
  },
  compact: {
    opacity: 1,
    y: 0,
    scale: 0.975,
    rotateZ: 0.0001,
  },
}

const navBubble = ref(false)
const footerVisible = ref(false)
const pageScroll = ref(null)
const scrollTarget = ref(null)

const normalLink = (path, accent = false) => {
  const active = route.path === path
  return [
    'nav-link px-3 py-2 rounded-full text-sm font-medium transition-colors duration-200',
    active
      ? accent
        ? 'text-emerald-200 bg-white/5 border border-emerald-300/30'
        : 'text-white'
      : 'text-gray-300 hover:text-white hover:bg-white/5',
  ]
}

const compactLink = (path) => {
  const active = route.path === path
  return [
    'nav-link px-4 py-2 rounded-full text-sm font-medium transition-colors duration-200',
    active ? 'bg-white/10 text-emerald-200' : 'text-white/80 hover:text-white hover:bg-white/5',
  ]
}

const menuOpen = ref(false)
const mobileMenuOpen = ref(false)

const auth = useAuthStore()

const currentUser = computed(() => {
  const u = auth.user
  return u && typeof u === 'object' && 'value' in u ? u.value : u
})

const initials = computed(() => {
  const u = currentUser.value
  if (!u) return 'üôÇ'
  const f = u.firstName?.[0] || ''
  const l = u.lastName?.[0] || ''
  return (f + l || 'üôÇ').toUpperCase()
})

const isActiveMobile = (path) =>
  route.path === path
    ? 'bg-gray-900 text-purple-400'
    : 'text-gray-300 hover:bg-gray-700 hover:text-white'

const closeMenus = () => {
  menuOpen.value = false
  mobileMenuOpen.value = false
}

const toggleUserMenu = () => {
  menuOpen.value = !menuOpen.value
  if (menuOpen.value) mobileMenuOpen.value = false
}

const toggleMobileMenu = () => {
  mobileMenuOpen.value = !mobileMenuOpen.value
  if (mobileMenuOpen.value) menuOpen.value = false
}

const handleScroll = () => {
  const scroller = pageScroll.value
  const top = scroller?.scrollTop ?? window.scrollY
  const client = scroller?.clientHeight ?? window.innerHeight
  const scrollHeight = scroller?.scrollHeight ?? document.body.scrollHeight
  navBubble.value = !isStats.value && top > 12
  footerVisible.value = !isStats.value && top + client >= scrollHeight - 140
}

const attachScroll = () => {
  const target = pageScroll.value || window
  scrollTarget.value = target
  target.addEventListener('scroll', handleScroll, { passive: true })
  handleScroll()
}

const detachScroll = () => {
  if (scrollTarget.value) {
    scrollTarget.value.removeEventListener('scroll', handleScroll)
    scrollTarget.value = null
  }
}

const onWindowClick = (e) => {
  if (e.target.closest('header')) return
  closeMenus()
}

const onKeyDown = (e) => {
  if (e.key === 'Escape') closeMenus()
}

onMounted(() => {
  window.addEventListener('click', onWindowClick)
  window.addEventListener('keydown', onKeyDown)
  attachScroll()
})

onBeforeUnmount(() => {
  window.removeEventListener('click', onWindowClick)
  window.removeEventListener('keydown', onKeyDown)
  detachScroll()
})

watch(
  () => route.meta.fullBleed,
  (v) => {
    document.body.classList.toggle('no-scroll', !!v)
  },
  { immediate: true },
)

watch(
  () => route.fullPath,
  async () => {
    closeMenus()
    detachScroll()
    await nextTick()
    attachScroll()
  },
)

const goToAuth = (mode) => {
  closeMenus()
  router.push({ name: 'auth', query: { mode } })
}

const goToAccount = () => {
  closeMenus()
  router.push({ name: 'account' })
}

const logout = () => {
  auth.logout()
  closeMenus()
  router.push({ name: 'auth', query: { mode: 'login' } })
}
</script>

<style>
.toolbar {
  animation: toolbarIn 280ms cubic-bezier(0.2, 0.9, 0.2, 1) both;
  top: 76px;
}

@keyframes toolbarIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

html,
body,
#app {
  height: 100%;
}
</style>
